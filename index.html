<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="tailwind.css">
    <title>Meal App</title>
</head>
<body>

    <div class="flex flex-col items-center container mx-auto px-4 ">
        <!--Titre de la recette-->
        <h1 id="meal" class="text-5xl font-black">Titre de la recette</h1>
        <!--Image de la recette-->
        <div class="my-8 rounded-xxl shadow-lg overflow-hidden">
            <img id='imageMeal' width="256" src="https://user-media-prod-cdn.itsre-sumo.mozilla.net/uploads/images/2016-09-21-05-08-41-46dd20.png" />
        </div>
        <!--Bouton favoris-->
        <div class="p-2 bg-pink-50 rounded mb-6">
            <a  class="text-pink-500 background-transparent font-bold uppercase px-6 py-2 text-sm outline-none focus:outline-none mr-1 mb-1" >Ajouter aux favoris</a>
        </div>
        <!--Liste des ingr√©dients-->
        <div id="list-ingredient" class="flex flex-row flex-wrap">
        <!--Instructions-->
        </div>
        <p id="instructions" class="rounded bg-gray-50 p-4">Loading instructions...</p>
    </div>
    <!--Menu-->
    <div class="flex flex-col items-end container mx-auto px-4" >
        <ul >
            <li class="text-pink-500 background-transparent font-bold uppercase px-6 py-2 text-sm outline-none focus:outline-none mr-1 mb-1"><a href="index.html" >Accueil</a></li>
            <li class="text-pink-500 background-transparent font-bold uppercase px-6 py-2 text-sm outline-none focus:outline-none mr-1 mb-1"><a href="fav.html" >Mes fav's</a></li>
            <li class="text-pink-500 background-transparent font-bold uppercase px-6 py-2 text-sm outline-none focus:outline-none mr-1 mb-1" ><a href="week.html" >Ma semaine</a></li>
        </ul>
    </div>
    <!--Fonction secouer-->
    <script src="shake.js"></script>

    <script>
        //ins√©rer les donn√©es de l'api au bon endroit grace aux ID
        const ul = document.getElementById("list-ingredient");
        const instructions = document.getElementById("instructions");
        const mealTitle = document.getElementById("meal");
        const imageMeal = document.getElementById("imageMeal");

        //fonction secouer
        var myShakeEvent = new Shake({
            threshold: 15, // optional shake strength threshold
            timeout: 1000 // optional, determines the frequency of event generation
        });
        myShakeEvent.start();

        window.addEventListener('shake', shakeEventDidOccur, false);

        //function to call when shake occurs
        function shakeEventDidOccur () {

            //put your own code here etc.
            console.log('shaked ü§å');
        }
        
        //Charge une recette random
        function loadRandomRecipe() {
            //1. Se connecter √† l'API MealDB
            //On cree la requete
            let requestURL = 'https://www.themealdb.com/api/json/v1/1/random.php';
            let request = new XMLHttpRequest();
            request.open('GET', requestURL);
            request.responseType = 'text';
            
             //2. R√©cuperer une recette random
            //Envoi de la requete
            request.send();

            //Au moment de la r√©cup√©ration (r√©ponse du serveur)
            request.onload = function() {
                //On execute ce code
                const mealText = request.response;
                const meals = JSON.parse(mealText);
                //console.log(meals);
                showMeal(meals);
                addFav(meals);
            }
        }
   
        //3. L'afficher de mani√®re jolie
        function showMeal(dataFromServer){
            //On va boucler sur les donn√©es
            var myRecipe = dataFromServer.meals[0];
            
            //Ingredients List
            for(var i=1; i <= 20; i++){
                ingredientValue = myRecipe["strIngredient" + i];
                if(ingredientValue !== ''){
                    const ingredient = document.createElement('div');
                    ingredient.className = 'm-2 p-2 bg-indigo-200 rounded text-indigo-900';
                    ingredient.textContent = ingredientValue;
                    //pour ins√©rer entre les balises ul
                    ul.appendChild(ingredient);
                }
            }
            
            //Instructions
            instructionsValue = myRecipe.strInstructions;
            instructions.innerHTML= instructionsValue;
            
            //Title 
            mealTitleValue = myRecipe.strMeal;
            mealTitle.innerHTML = mealTitleValue;

            //image
            imageValue=myRecipe.strMealThumb;
            imageMeal.src=imageValue;

        }

        loadRandomRecipe();

        //4. Ajouter en favoris
        // Cr√©er/Modifier un fichier JSON avec le tableau des recettes

        function addFav(dataFromServer){

            var myRecipe = dataFromServer.meals[0];
            var favsRecipe=localStorage.getItem('favRecipes');
            var i =favsRecipe.length;
            favsRecipe[i]=myRecipe;
            
            console.log(favsRecipe[0]);
            console.log(myRecipe); 
            console.log(favsRecipe);


        
            
            //donn√©es n√©cessaire pour le localStorage
            location
            //r√©cup√©ration des favoris deja enregistr√©
            var favMeal_json = sessionStorage.getItem("meal");
            //var favMeal = JSON.parse(favMeal_json);
            //calcul de la premiere case vide dans le tableau
            var casevide =favMeal_json.length;
            console.log(casevide);
            //ajout de la nouvelle recette dans le tableau[premiereCaseVide]
            var favMeal=dataFromServer.meals[casevide];
            favMeal_json
            //enregistrer le document en local 

            //enregistrer en local storage
            var favMeal_json = JSON.stringify(favMeal);
            sessionStorage.setItem("meal",favMeal_json);
            
            // Affichage dans la console
            console.log(favMeal);

            var locate = "C:\Users\fanny\Documents\Code\Meal\MealApp";
            var storeData = []; 
            localStorage.setItem("locate", JSON.stringify(locate));
            localStorage.setItem("details", JSON.stringify(favMeal));
            //alert("The recipe is added to favorite !");

            var date = new Date,
                day = date.getDate(),
                month = date.getMonth() + 1,
                year = date.getFullYear(),
                hour = date.getHours(),
                minute = date.getMinutes(),
                ampm = hour > 12 ? "PM" : "AM";    
                hour = hour % 12;
                hour = hour ? hour : 12; // zero = 12
                minute = minute > 9 ? minute : "0" + minute;
                hour = hour > 9 ? hour : "0" + hour;

                date = month + "/" + day + "/" + year + " " + hour + ":" + minute +  " " + ampm;

            localStorage.setItem("date", JSON.stringify(date));
            storeData.push(locate, favMeal, date);
            localStorage.setItem("storeData", JSON.stringify(storeData));   
}      
    </script>
</body>
</html>